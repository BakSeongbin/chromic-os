<!doctype html>
<html id="t" i18n-values="dir:textdirection;lang:language">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title i18n-content="title"></title>
    <link rel="stylesheet" href="chrome://resources/css/text_defaults.css">
    <style>/* Copyright 2013 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 */

#anchor {
  display: none;
}

body {
  font-size: 84%;
  margin: 0;
  min-width: 45em;
  padding: 0.75em;
}

.global-button {
  margin: 1px 3px 0 3px;
}

h1,
h2 {
  margin: 0;
}

h1 {
  color: rgb(74, 142, 230);
  font-size: 110%;
  font-weight: bold;
  padding: 0;
}

h2 {
  -webkit-padding-end: 1em;
  -webkit-padding-start: 0;
  color: rgb(58, 117, 189);
  display: inline-block;
  font-size: 110%;
  font-weight: normal;
}

#header {
  background: rgb(82, 150, 222);
  background-size: 100%;
  border: 1px solid rgb(58, 117, 189);
  border-radius: 6px;
  color: white;
  margin-bottom: 0.75em;
  overflow: hidden;
  padding: 0.5em 0;
  position: relative;
  text-shadow: 0 0 2px black;
}

html[dir='rtl'] #header {
  padding: 0.6em 0 0.75em 1em;
}

#header h1 {
  color: white;
  display: inline;
}

div#header h1::before {
  /* grit doesn't flatten -webkit-mask, so define the properties separately
  * for now. */
  -webkit-mask-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNHB4IiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0iIzAwMDAwMCI+CiAgICA8cGF0aCBkPSJNMCAwaDQ4djQ4SDB6IiBmaWxsPSJub25lIi8+CiAgICA8cGF0aCBkPSJNMzguODYgMjUuOTVjLjA4LS42NC4xNC0xLjI5LjE0LTEuOTVzLS4wNi0xLjMxLS4xNC0xLjk1bDQuMjMtMy4zMWMuMzgtLjMuNDktLjg0LjI0LTEuMjhsLTQtNi45M2MtLjI1LS40My0uNzctLjYxLTEuMjItLjQzbC00Ljk4IDIuMDFjLTEuMDMtLjc5LTIuMTYtMS40Ni0zLjM4LTEuOTdMMjkgNC44NGMtLjA5LS40Ny0uNS0uODQtMS0uODRoLThjLS41IDAtLjkxLjM3LS45OS44NGwtLjc1IDUuM2MtMS4yMi41MS0yLjM1IDEuMTctMy4zOCAxLjk3TDkuOSAxMC4xYy0uNDUtLjE3LS45NyAwLTEuMjIuNDNsLTQgNi45M2MtLjI1LjQzLS4xNC45Ny4yNCAxLjI4bDQuMjIgMy4zMUM5LjA2IDIyLjY5IDkgMjMuMzQgOSAyNHMuMDYgMS4zMS4xNCAxLjk1bC00LjIyIDMuMzFjLS4zOC4zLS40OS44NC0uMjQgMS4yOGw0IDYuOTNjLjI1LjQzLjc3LjYxIDEuMjIuNDNsNC45OC0yLjAxYzEuMDMuNzkgMi4xNiAxLjQ2IDMuMzggMS45N2wuNzUgNS4zYy4wOC40Ny40OS44NC45OS44NGg4Yy41IDAgLjkxLS4zNy45OS0uODRsLjc1LTUuM2MxLjIyLS41MSAyLjM1LTEuMTcgMy4zOC0xLjk3bDQuOTggMi4wMWMuNDUuMTcuOTcgMCAxLjIyLS40M2w0LTYuOTNjLjI1LS40My4xNC0uOTctLjI0LTEuMjhsLTQuMjItMy4zMXpNMjQgMzFjLTMuODcgMC03LTMuMTMtNy03czMuMTMtNyA3LTcgNyAzLjEzIDcgNy0zLjEzIDctNyA3eiIvPgo8L3N2Zz4K);
  -webkit-mask-position: center;
  -webkit-mask-repeat: no-repeat;
  -webkit-mask-size: 24px;
  background-color: white;
  content: '';
  display: inline-block;
  height: 20px;
  vertical-align: middle;
  width: 37px;
}

#header p {
  -webkit-padding-start: 0.4em;
  color: white;
  display: inline;
  font-size: 84%;
  font-style: italic;
}

.list {
  border-collapse: collapse;
  font-size: 84%;
  line-height: 200%;
  width: 100%;
}

.list:not(.filtered) tr:nth-child(odd) td {
  background: rgb(239, 243, 255);
}

.list td {
  font-family: 'Courier New', monospace;
  line-height: 1.4em;
  padding: 0 0.5em;
  padding-top: 0.35em;
  vertical-align: top;
}

.list tr td:nth-last-child(1),
.list tr th:nth-last-child(1) {
  -webkit-padding-end: 1em;
}

.list:not(.filtered) .tab .name {
  -webkit-padding-start: 1.5em;
}

.list .name {
  width: 20%;
}

.list .button-cell {
  width: 7%;
}

.list .name div {
  height: 1.6em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.button-hidden {
  display: none;
}

.number-expanded,
.number-collapsed  {
  text-align: left;
  text-overflow: ellipsis;
  width: 80%;
}

html[dir='rtl'] .number-expanded,
html[dir='rtl'] .number-collapsed  {
  text-align: right;
}

tr > *:nth-child(1),
tr > *:nth-child(2) {
  -webkit-border-end: 1px solid rgb(181, 198, 222);
}

.name {
  background-position: 5em center;
  background-repeat: no-repeat;
}

.stat-value {
  text-overflow: ellipsis;
  white-space: pre-wrap;
}

html[dir='rtl'] #details .name {
  background-position-left: auto;
  background-position-right: 5em;
}

.number-collapsed .stat-value {
  display: none;
}

.number-expanded .stat-value {
  display: auto;
}

#status {
  color: rgb(255, 0, 0);
  margin: .5em 0;
}
</style>
    <script src="chrome://resources/js/util.js"></script>
    <script src="chrome://resources/js/i18n_template_no_process.js"></script>
    <script src="chrome://resources/js/jstemplate_compiled.js"></script>
    <script>// Copyright 2013 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// Contents of lines that act as delimiters for multi-line values.
var DELIM_START = '---------- START ----------';
var DELIM_END = '---------- END ----------';

// Limit file size to 10 MiB to prevent hanging on accidental upload.
var MAX_FILE_SIZE = 10485760;

function getValueDivForButton(button) {
  return $(button.id.substr(0, button.id.length - 4));
}

function getButtonForValueDiv(valueDiv) {
  return $(valueDiv.id + '-btn');
}

function handleDragOver(e) {
  e.dataTransfer.dropEffect = 'copy';
  e.preventDefault();
}

function handleDrop(e) {
  var file = e.dataTransfer.files[0];
  if (file) {
    e.preventDefault();
    importLog(file);
  }
}

function showError(fileName) {
  $('status').textContent = loadTimeData.getStringF('parseError', fileName);
}

/**
 * Toggles whether an item is collapsed or expanded.
 */
function changeCollapsedStatus() {
  var valueDiv = getValueDivForButton(this);
  if (valueDiv.parentNode.className == 'number-collapsed') {
    valueDiv.parentNode.className = 'number-expanded';
    this.textContent = loadTimeData.getString('collapseBtn');
  } else {
    valueDiv.parentNode.className = 'number-collapsed';
    this.textContent = loadTimeData.getString('expandBtn');
  }
}

/**
 * Collapses all log items.
 */
function collapseAll() {
  var valueDivs = document.getElementsByClassName('stat-value');
  for (var i = 0; i < valueDivs.length; i++) {
    var button = getButtonForValueDiv(valueDivs[i]);
    if (button && button.className != 'button-hidden') {
      button.textContent = loadTimeData.getString('expandBtn');
      valueDivs[i].parentNode.className = 'number-collapsed';
    }
  }
}

/**
 * Expands all log items.
 */
function expandAll() {
  var valueDivs = document.getElementsByClassName('stat-value');
  for (var i = 0; i < valueDivs.length; i++) {
    var button = getButtonForValueDiv(valueDivs[i]);
    if (button && button.className != 'button-hidden') {
      button.textContent = loadTimeData.getString('collapseBtn');
      valueDivs[i].parentNode.className = 'number-expanded';
    }
  }
}

/**
 * Collapse only those log items with multi-line values.
 */
function collapseMultiLineStrings() {
  var valueDivs = document.getElementsByClassName('stat-value');
  var nameDivs = document.getElementsByClassName('stat-name');
  for (var i = 0; i < valueDivs.length; i++) {
    var button = getButtonForValueDiv(valueDivs[i]);
    button.onclick = changeCollapsedStatus;
    if (valueDivs[i].scrollHeight > (nameDivs[i].scrollHeight * 2)) {
      button.className = '';
      button.textContent = loadTimeData.getString('expandBtn');
      valueDivs[i].parentNode.className = 'number-collapsed';
    } else {
      button.className = 'button-hidden';
      valueDivs[i].parentNode.className = 'number';
    }
  }
}

/**
 * Read in a log asynchronously, calling parseSystemLog if successful.
 * @param {File} file The file to read.
 */
function importLog(file) {
  if (file && file.size <= MAX_FILE_SIZE) {
    var reader = new FileReader();
    reader.onload = function() {
      if (parseSystemLog(this.result)) {
        // Reset table title and status
        $('tableTitle').textContent =
              loadTimeData.getStringF('logFileTableTitle', file.name);
        $('status').textContent = '';
      } else {
        showError(file.name);
      }
    };
    reader.readAsText(file);
  } else if (file) {
    showError(file.name);
  }
}

/**
 * Convert text-based log into list of name-value pairs.
 * @param {string} text The raw text of a log.
 * @return {boolean} True if the log was parsed successfully.
 */
function parseSystemLog(text) {
  var details = [];
  var lines = text.split('\n');
  for (var i = 0, len = lines.length; i < len; i++) {
    // Skip empty lines.
    if (!lines[i])
      continue;

    var delimiter = lines[i].indexOf('=');
    if (delimiter <= 0) {
      if (i == lines.length - 1)
         break;
      // If '=' is missing here, format is wrong.
      return false;
    }

    var name = lines[i].substring(0, delimiter);
    var value = '';
    // Set value if non-empty
    if (lines[i].length > delimiter + 1)
      value = lines[i].substring(delimiter + 1);

    // Delimiters are based on kMultilineIndicatorString, kMultilineStartString,
    // and kMultilineEndString in components/feedback/feedback_data.cc.
    // If these change, we should check for both the old and new versions.
    if (value == '<multiline>') {
      // Skip start delimiter.
      if (i == len - 1 ||
          lines[++i].indexOf(DELIM_START) == -1)
        return false;

      ++i;
      value = '';
      // Append lines between start and end delimiters.
      while (i < len && lines[i] != DELIM_END)
        value += lines[i++] + '\n';

      // Remove trailing newline.
      if (value)
        value = value.substr(0, value.length - 1);
    }
    details.push({'statName': name, 'statValue': value});
  }

  var templateData = {'details': details};
  jstProcess(new JsEvalContext(templateData), $('t'));

  collapseMultiLineStrings();
  return true;
}

document.addEventListener('DOMContentLoaded', function() {
  jstProcess(loadTimeData.createJsEvalContext(), $('t'));

  $('collapseAll').onclick = collapseAll;
  $('expandAll').onclick = expandAll;

  var tp = $('t');
  tp.addEventListener('dragover', handleDragOver, false);
  tp.addEventListener('drop', handleDrop, false);

  collapseMultiLineStrings();
});
</script>
  </head>
  <body>
    <div id="header">
      <h1 i18n-content="title"></h1>
      <p i18n-content="description"></p>
    </div>
    <div id="content">
      <h2 id="tableTitle" i18n-content="tableTitle"></h2>
      <div id="anchor" jscontent="anchor"></div>
      <button id="expandAll" class="global-button" i18n-content="expandAllBtn">
      </button>
      <button id="collapseAll" class="global-button"
          i18n-content="collapseAllBtn"></button>
      <p id="status"></p>
      <table class="list" id="details">
        <tr jsselect="details">
          <td class="name">
            <div class="stat-name" jscontent="statName"></div>
          </td>
          <td class="button-cell">
            <button jsvalues="id:statName + '-value-btn'"
              class="expand-status"></button>
          </td>
          <td class="number">
            <div class="stat-value" jscontent="statValue"
              jsvalues="id:statName + '-value'"></div>
          </td>
        </tr>
      </table>
    </div>
  </body>
</html>
